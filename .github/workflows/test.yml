name: Test

on:
  push:
    branches: [ main, develop, copilot/** ]
  pull_request:
    branches: [ main, develop ]

env:
  CARGO_TERM_COLOR: always

jobs:
  test:
    name: Test Suite
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        components: rustfmt, clippy
    
    - name: Cache cargo registry
      uses: actions/cache@v4
      with:
        path: ~/.cargo/registry
        key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
    
    - name: Cache cargo index
      uses: actions/cache@v4
      with:
        path: ~/.cargo/git
        key: ${{ runner.os }}-cargo-index-${{ hashFiles('**/Cargo.lock') }}
    
    - name: Cache cargo build
      uses: actions/cache@v4
      with:
        path: target
        key: ${{ runner.os }}-cargo-build-target-${{ hashFiles('**/Cargo.lock') }}
    
    - name: Check formatting
      run: cargo fmt --all -- --check
    
    - name: Run clippy on library (strict)
      run: cargo clippy --lib -- -D warnings
    
    - name: Run clippy on all targets (allow warnings)
      run: cargo clippy --all-targets --all-features
    
    - name: Build
      run: cargo build --verbose
    
    - name: Run library tests
      run: cargo test --lib --verbose
    
    - name: Run integration tests
      run: cargo test --test integration_tests --verbose
    
    - name: Run sled engine tests
      run: cargo test --test sled_engine_tests --verbose
    
    - name: Run storage tests
      run: cargo test --test storage_tests --verbose
    
    - name: Run consensus integration tests
      run: cargo test --test consensus_tests --verbose
    
    - name: Run all tests
      run: cargo test --verbose
    
    - name: Test config module
      run: cargo test --lib 'config::' --verbose
    
    - name: Test error module
      run: cargo test --lib 'error::' --verbose
    
    - name: Test types module
      run: cargo test --lib 'types::' --verbose
    
    - name: Test storage module
      run: cargo test --lib 'storage::' --verbose
    
    - name: Test segment module
      run: cargo test --lib 'storage::segment::' --verbose
    
    - name: Test consensus type_config module
      run: cargo test --lib 'consensus::type_config::' --verbose
    
    - name: Test consensus state_machine module
      run: cargo test --lib 'consensus::state_machine::' --verbose
    
    - name: Test consensus storage module
      run: cargo test --lib 'consensus::storage::' --verbose
    
    - name: Test consensus network module
      run: cargo test --lib 'consensus::network::' --verbose
    
    - name: Test consensus module
      run: cargo test --lib 'consensus::tests::' --verbose
    
    - name: Test manifest module
      run: cargo test --lib 'manifest::' --verbose
    
    - name: Run manifest integration tests
      run: cargo test --test manifest_tests --verbose
    
    - name: Run performance regression tests
      run: cargo test --test performance_regression_tests --verbose
    
    - name: Run HTTP API tests
      run: cargo test --test http_tests --verbose
    
    - name: Run discovery service tests
      run: cargo test --test discovery_tests --verbose
    
    - name: Test discovery module
      run: cargo test --lib 'discovery::' --verbose
    
    - name: Run cluster initialization tests
      run: cargo test --test cluster_tests --verbose
    
    - name: Test cluster module
      run: cargo test --lib 'cluster::' --verbose

    - name: Run write request tests (Task 7.1)
      run: cargo test --test write_request_tests --verbose

    - name: Test api module (Task 7.1)
      run: cargo test --lib 'api::' --verbose

    - name: Run read request tests (Task 7.2)
      run: cargo test --test read_request_tests --verbose

    - name: Run consistency tests (Task 7.3)
      run: cargo test --test consistency_tests --verbose

    - name: Run node binary tests (Task 8.1)
      run: cargo test --test node_binary_tests --verbose

    - name: Run E2E infrastructure tests (Task 8.2 & 8.3)
      run: cargo test --test e2e_infrastructure_tests --verbose

    - name: Run S3 storage tests (Task 6.1)
      run: cargo test --test s3_storage_tests --verbose

    - name: Run segment archival tests (Task 6.2)
      run: cargo test --test segment_archival_tests --verbose

    - name: Run data tiering tests (Task 6.3)
      run: cargo test --test data_tiering_tests --verbose

    - name: Test crypto module (Task 10.1)
      run: cargo test --lib 'crypto::' --verbose

    - name: Run crypto tests (Task 10.1)
      run: cargo test --test crypto_tests --verbose

    - name: Run verification tests (Task 10.2)
      run: cargo test --test verification_tests --verbose

    - name: Run metrics and logging tests (Task 11.1 & 11.2)
      run: cargo test --test metrics_logging_tests --verbose

    - name: Test metrics module (Task 11.1)
      run: cargo test --lib 'metrics::' --verbose

    - name: Test logging module (Task 11.2)
      run: cargo test --lib 'logging::' --verbose

    - name: Run performance optimization tests (Task 11.3)
      run: cargo test --test performance_optimization_tests --verbose

    - name: Test cache module (Task 11.3)
      run: cargo test --lib 'cache::' --verbose

    - name: Run security tests (Task 11.4)
      run: cargo test --test security_tests --verbose

    - name: Test security module (Task 11.4)
      run: cargo test --lib 'security::' --verbose
